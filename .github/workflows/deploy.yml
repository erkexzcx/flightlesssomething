name: Deploy Dev

on:
  push:
    branches:
      - '**'
      - '!main'
      - '!dependabot/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t flightlesssomething:${{ github.sha }} .

      - name: Move cache
        run: |
          if [ -d /tmp/.buildx-cache-new ]; then
            rm -rf /tmp/.buildx-cache
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
            echo "Cache moved successfully"
          else
            echo "Warning: No new cache directory found, skipping cache move"
          fi

      - name: Save Docker image
        run: |
          docker save flightlesssomething:${{ github.sha }} | gzip > image.tar.gz

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          if [ -n "${{ secrets.SSH_PORT }}" ]; then
            ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          else
            ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          fi

      - name: Deploy to dev server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DOCKER_NETWORK: ${{ secrets.DOCKER_NETWORK }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_SECRET: ${{ secrets.DISCORD_SECRET }}
          DISCORD_REDIRECT_URL: ${{ secrets.DISCORD_REDIRECT_URL }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          APP_DIR="flightlesssomething-dev"
          CONTAINER_NAME="flightlesssomething-dev"
          IMAGE_TAG="${GITHUB_SHA}"

          # Create directory on remote server
          ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} "mkdir -p ~/${APP_DIR}/data"

          # Transfer Docker image
          scp -P ${SSH_PORT} image.tar.gz ${SSH_USER}@${SSH_HOST}:~/${APP_DIR}/

          # Deploy on remote server
          ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} "
            cd ~/${APP_DIR}
            
            # Load Docker image
            docker load < image.tar.gz
            docker tag flightlesssomething:${IMAGE_TAG} flightlesssomething:dev-latest
            
            # Stop and remove old container
            docker stop ${CONTAINER_NAME} || true
            docker rm ${CONTAINER_NAME} || true
            
            # Start new container
            docker run -d \
              --name ${CONTAINER_NAME} \
              --network ${DOCKER_NETWORK} \
              --restart unless-stopped \
              -v ~/${APP_DIR}/data:/data \
              -e FS_BIND=0.0.0.0:5000 \
              -e FS_DATA_DIR=/data \
              -e FS_SESSION_SECRET=${SESSION_SECRET} \
              -e FS_DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID} \
              -e FS_DISCORD_CLIENT_SECRET=${DISCORD_SECRET} \
              -e FS_DISCORD_REDIRECT_URL=${DISCORD_REDIRECT_URL} \
              -e FS_ADMIN_USERNAME=${ADMIN_USERNAME} \
              -e FS_ADMIN_PASSWORD=${ADMIN_PASSWORD} \
              flightlesssomething:dev-latest
            
            # Cleanup
            rm -f image.tar.gz
            
            # Prune old images
            docker image prune -af --filter 'until=24h' || true
          "
